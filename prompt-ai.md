# OBSIDIAN批注插件开发指令

你需要编写一个完整的Obsidian插件，实现以下所有功能，按照规范一次性正确实现，不得有任何延迟、丢失、覆盖等问题。

---

## 核心功能清单

1. 批注创建：PC端右键菜单“批注”，移动端单击浮动菜单“批注”，弹出输入框保存批注内容，批注文件存放在用户可配置的文件夹（默认_annotations），文件命名格式为“原文件名-annotation.md”，每条批注包含唯一ID、选中文本、位置信息、创建时间、更新时间、Markdown格式的批注内容，严禁修改原文。

2. 正文高亮：所有批注必须在保存后立即在正文中显示高亮背景，高亮必须稳定、不延迟、不丢失、不互相覆盖，使用MarkdownPostProcessor动态注入span。

3. 批注查看：PC端双击高亮文字弹出悬浮卡片，完整渲染Markdown批注内容，支持滚动条；移动端双击高亮文字弹出悬浮卡片，支持滚动避免全屏遮挡。

4. 批注编辑：悬浮卡片内直接编辑批注内容，失焦自动保存，无需二次弹窗，保存后右侧边栏卡片与批注文件立即同步更新。

5. 批注删除：悬浮卡片右下角与右侧边栏卡片右下角均提供删除按钮，删除后正文高亮立即移除、右侧边栏卡片立即移除、批注文件中对应条目立即删除，当某文章所有批注被删除时自动删除该批注文件。

6. 右侧边栏：插件开启状态下打开文章自动在右侧折叠栏显示当前文章的批注列表（与出链列表同级），卡片显示原文片段、Markdown批注内容、创建时间（左下角默认隐藏鼠标悬浮显示）、操作按钮（定位原文、跳转批注文件、删除），卡片高度自适应内容，图片链接默认显示文字鼠标悬浮预览，点击卡片使左侧正文对应高亮呈现选中效果。

7. 双向跳转：右侧卡片定位原文跳转到正文对应高亮处并高亮选中，右侧卡片跳转批注文件定位到批注文件中该条批注的具体位置，Ctrl+鼠标左键点击正文高亮跳转到批注文件中该条批注的具体位置，批注文件中点击跳转到正文对应高亮处。

8. 配置项：插件设置页提供批注存储文件夹自定义（默认_annotations）、右侧边栏自动显示开关、高亮颜色选择器、移动端启用开关。

9. 移动端适配：默认不开启右侧边栏，手指单击选中文字出现浮动菜单批注，手指双击高亮文字弹出悬浮卡片，卡片可滚动，编辑删除跳转功能与PC端保持一致。

10. 数据存储：批注文件采用Markdown格式，每条批注使用YAML frontmatter或分隔符独立存储，必须包含annotation_id、selected_text、position（含文件路径、偏移量/行号）、created、updated，正文位置需支持精准定位。

11. 实时更新：所有增删改操作必须立即触发视图更新（正文高亮、右侧列表、悬浮卡片），不得依赖手动刷新或切换视图。

12. 图片链接处理：Markdown图片语法仅显示链接文字，鼠标悬浮时显示小窗预览，不得自动加载图片挤占布局。

---

## 技术要求

- 遵循Obsidian插件官方规范，使用TypeScript编写
- 使用Obsidian API：MarkdownPostProcessor、ItemView、addCommand、addRibbonIcon、registerEvent、Workspace、Vault、MetadataCache等
- 样式区分PC端与移动端（CSS媒体查询）
- 批注定位优先使用行号+偏移量，备选块ID或段落索引
- 跨文件跳转使用obsidian://协议或内置API

---

## 验收标准（必须全部通过）

- [ ] 选中文字右键批注保存后正文立即高亮、右侧立即出现卡片、批注文件正确生成
- [ ] 双击正文高亮弹出悬浮卡片渲染正确
- [ ] 悬浮卡片内编辑失焦后右侧卡片与批注文件同步更新
- [ ] 删除批注后正文高亮移除、右侧卡片移除、批注文件对应条目删除
- [ ] 删除全部批注后批注文件自动删除
- [ ] 右侧卡片定位原文跳转正确并高亮选中
- [ ] Ctrl+左键点击正文高亮跳转到批注文件具体位置
- [ ] 批注文件夹路径可在设置页自定义
- [ ] 重启Obsidian后打开已批注文章右侧边栏自动加载
- [ ] 批注内容支持粗体斜体链接代码块
- [ ] 图片链接显示文字，鼠标悬浮显示预览
- [ ] 移动端单击选中出现批注菜单，双击高亮弹出滚动卡片
- [ ] 所有增删改操作均实时响应无延迟

---

## 约束条件

- 严禁修改原文文件
- 批注文件必须存放在独立文件夹
- 代码必须完整、可编译、无类型错误
- 注释清晰，关键逻辑写明说明

---

开始编写。